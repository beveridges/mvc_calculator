{% extends "base.html" %}

{% block extrahead %}
  {{ super() }}
  {# Redirect root index page to user-guide - runs immediately #}
  <script>
    (function() {
      var currentPath = window.location.pathname;
      // Detect if we're on the root index page
      var isRootIndex = (currentPath === '/' || 
                        currentPath === '/index.html' || 
                        (currentPath.endsWith('/index.html') && currentPath.split('/').filter(function(p) { return p && p !== 'index.html' && p !== ''; }).length === 0));
      
      // Redirect any root index page to user-guide
      if (isRootIndex) {
        // Redirect to user-guide
        if (window.location.protocol === 'file:') {
          // For file:// protocol, construct relative path
          var currentDir = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
          if (currentDir === '') currentDir = '/';
          window.location.replace('file://' + currentDir + '/user-guide/index.html');
        } else {
          // For http:// protocol
          var baseUrl = window.location.protocol + '//' + window.location.host;
          window.location.replace(baseUrl + '/user-guide/');
        }
      }
    })();
  </script>
  {# Inject version between logo and search using JavaScript #}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var logoLink = document.querySelector('.wy-side-nav-search > a');
      var searchDiv = document.querySelector('.wy-side-nav-search div[role="search"]');
      if (logoLink && searchDiv && logoLink.parentNode) {
        // Make logo non-clickable by removing href and preventing click
        logoLink.removeAttribute('href');
        logoLink.style.cursor = 'default';
        logoLink.style.pointerEvents = 'none';
      
        logoLink.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        });
        
        // Create version div
        var versionDiv = document.createElement('div');
        versionDiv.className = 'inline-version';
        versionDiv.style.cssText = 'text-align:center; margin:8px 0;';
        
        // Read version HTML from template file
        {% set version_html %}{% include "partials/version_inline.html" %}{% endset %}
        {% set version_js = version_html|replace('"', '\\"')|replace('\n', ' ')|replace('\r', '')|trim %}
        versionDiv.innerHTML = "{{ version_js }}";
        
        // Insert between logo and search (after the logo link, before search)
        logoLink.parentNode.insertBefore(versionDiv, searchDiv);
        
        // Force layout recalculation to fix spacing issues and sidebar scroll position
        // Use multiple requestAnimationFrame calls to ensure it happens after all rendering
        requestAnimationFrame(function() {
          requestAnimationFrame(function() {
            // Trigger reflow by reading layout properties
            var height = versionDiv.offsetHeight;
            var parent = logoLink.parentNode;
            if (parent) {
              parent.style.display = 'none';
              parent.offsetHeight; // Force reflow
              parent.style.display = '';
            }
            
            // Ensure sidebar is scrolled to top - try multiple selectors
            var sidebar = document.querySelector('.wy-side-scroll');
            if (sidebar) {
              sidebar.scrollTop = 0;
            }
            
            // Also check for the navigation menu container
            var navMenu = document.querySelector('.wy-menu');
            if (navMenu && navMenu.parentElement) {
              var navContainer = navMenu.parentElement;
              if (navContainer.scrollTop !== undefined) {
                navContainer.scrollTop = 0;
              }
            }
            
            // Check for wy-nav-side (the main sidebar container)
            var navSide = document.querySelector('.wy-nav-side');
            if (navSide && navSide.scrollTop !== undefined) {
              navSide.scrollTop = 0;
            }
            
            // One more frame to ensure everything is settled
            requestAnimationFrame(function() {
              // Final check - scroll all possible sidebar containers to top
              var allSidebars = document.querySelectorAll('.wy-side-scroll, .wy-nav-side, .wy-menu-vertical');
              allSidebars.forEach(function(sb) {
                if (sb && sb.scrollTop !== undefined) {
                  sb.scrollTop = 0;
                }
              });
            });
          });
        });
      }
      
      // Replace shields.io badges with CSS-styled badges for offline/MSI builds
      function replaceBadgesWithCSS() {
        var badges = document.querySelectorAll('img[alt="Build"], img[alt="Version"]');
        badges.forEach(function(img) {
          // Check if image failed to load or if we're offline
          var shouldReplace = false;
          if (window.location.protocol === 'file:') {
            // Always replace in offline mode
            shouldReplace = true;
          } else if (img.complete && img.naturalWidth === 0) {
            // Image failed to load
            shouldReplace = true;
          }
          
          if (shouldReplace) {
            var badge = document.createElement('span');
            badge.className = 'badge-inline ' + (img.alt === 'Build' ? 'build' : 'version');
            
            // Extract text from src URL
            var src = img.getAttribute('src') || '';
            var text = img.alt;
            
            if (src.includes('build-')) {
              var match = src.match(/build-([^-\?]+)/);
              if (match) {
                text = match[1].replace(/--/g, '-');
              }
            } else if (src.includes('version-')) {
              var match = src.match(/version-([^-\?]+)/);
              if (match) {
                text = match[1].replace(/--/g, '-');
              }
            }
            
            badge.textContent = text;
            img.parentNode.replaceChild(badge, img);
          } else {
            // Add error handler for images that fail after load
            img.onerror = function() {
              var badge = document.createElement('span');
              badge.className = 'badge-inline ' + (this.alt === 'Build' ? 'build' : 'version');
              var src = this.getAttribute('src') || '';
              var text = this.alt;
              if (src.includes('build-')) {
                var match = src.match(/build-([^-\?]+)/);
                if (match) text = match[1].replace(/--/g, '-');
              } else if (src.includes('version-')) {
                var match = src.match(/version-([^-\?]+)/);
                if (match) text = match[1].replace(/--/g, '-');
              }
              badge.textContent = text;
              this.parentNode.replaceChild(badge, this);
            };
          }
        });
      }
      
      // Run badge replacement immediately for file://, or after delay for http://
      if (window.location.protocol === 'file:') {
        replaceBadgesWithCSS();
      } else {
        setTimeout(replaceBadgesWithCSS, 500);
        setTimeout(replaceBadgesWithCSS, 2000);
      }
      
      // Fix navigation links for local file:// protocol
      // Convert directory links (ending with /) to index.html links
      if (window.location.protocol === 'file:') {
        var navLinks = document.querySelectorAll('.wy-menu a.reference.internal');
        navLinks.forEach(function(link) {
          var href = link.getAttribute('href');
          if (href && href.endsWith('/') && !href.endsWith('/index.html')) {
            // Convert ../troubleshooting/ to ../troubleshooting/index.html
            link.setAttribute('href', href + 'index.html');
          } else if (href && !href.includes('#') && !href.includes('.html') && !href.startsWith('#') && href !== '.') {
            // Handle links that don't have .html extension and aren't anchors
            if (!href.endsWith('/')) {
              link.setAttribute('href', href + '/index.html');
            }
          }
        });
        
        // Fix figure image links for file:// protocol
        // Convert relative image paths to absolute paths based on current location
        var images = document.querySelectorAll('figure img, .screenshot img, img.mvc-figure, .rst-content img');
        images.forEach(function(img) {
          var src = img.getAttribute('src');
          if (src && !src.match(/^(https?:|data:|#)/)) {
            // Relative path - convert to absolute path
            var currentPath = window.location.pathname;
            var currentDir = currentPath.substring(0, currentPath.lastIndexOf('/'));
            if (currentDir === '') currentDir = '/';
            
            // Handle different path formats
            if (src.startsWith('../')) {
              // Already relative, should work
            } else if (src.startsWith('/')) {
              // Absolute from root - keep as is
            } else {
              // Relative to current directory
              var basePath = currentDir;
              if (basePath.endsWith('/')) {
                basePath = basePath.slice(0, -1);
              }
              // Remove any intermediate directories (like user-guide/)
              var pathParts = basePath.split('/').filter(function(p) { return p && p !== 'index.html'; });
              // Reconstruct path
              var newPath = '/' + pathParts.join('/') + '/' + src;
              img.setAttribute('src', newPath);
            }
          }
        });
      }
    });
  </script>
{% endblock %}

{% block footer %}
<footer>
  <hr/>
  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>
  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  <br>
  <span class="footer-8bit">co-written with a robot ü§ñ‚ù§Ô∏è</span>
</footer>
{% endblock %}
