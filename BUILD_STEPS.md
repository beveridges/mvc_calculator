# Steps to Make a Build

## Overview

The build process creates Windows (MSI + ZIP) and Linux (DEB + AppImage) installers. The process is split into Windows and Linux builds, with the Windows build incrementing the version number that the Linux build then uses.

## Prerequisites

- **Windows:** Python, PyInstaller, WiX Toolset (for MSI)
- **WSL (Windows Subsystem for Linux):** Python, PyInstaller, required Linux build tools
- **Git:** For version control

## Build Steps

### Step 1: Make Changes and Commit

1. Make your code changes in your local repository
2. Test changes locally
3. Commit and push to GitHub:
   ```bash
   git add .
   git commit -m "Your commit message"
   git push
   ```

### Step 2: Update WSL Repository (if building Linux)

If you're building Linux versions, update your WSL repository:
```bash
# In WSL
git pull
```

### Step 3: Build Windows Versions

**Location:** Project root directory (run on Windows, not WSL)

```bash
python BUILD_ALL_WINDOWS.py
```

**What this does:**
1. Runs `build_windows_portable.py` - Creates PyInstaller onedir build and **increments build number**
2. Runs `build_windows_msi.py` - Creates MSI installer and portable ZIP

**Output location:**
```
C:\Users\Scott\Documents\.builds\mvc_calculator\MVC_Calculator-{BUILDNUMBER}\
├── MVC_Calculator-{version}.msi
├── MVC_Calculator-{version}-portable.zip
└── buildfiles\
    └── (build logs and artifacts)
```

**Important:** This must be run on Windows (not WSL) because it uses Windows-specific build tools.

### Step 4: Build Linux Versions (Optional)

**Location:** Project root directory (run in WSL)

```bash
python BUILD_ALL_LINUX.py
```

**What this does:**
1. Runs `build_linux_portable.py` - Linux portable build
2. Runs `build_linux_appimage.py` - Creates AppImage
3. Runs `build_linux_deb.py` - Creates .deb package
4. Copies files to Windows directory structure

**Output location:**
```
C:\Users\Scott\Documents\.builds\mvc_calculator\MVC_Calculator-{BUILDNUMBER}\
├── mvc-calculator_{version}_amd64.deb
├── MVC_Calculator-{version}-x86_64.AppImage
└── buildfiles\
    └── (build logs and artifacts)
```

**Note:** The Linux build reads the build number that was incremented by the Windows build, ensuring version consistency.

### Step 5: Create Release Notes (Optional but Recommended)

Create a release notes file:
```
C:\Users\Scott\Documents\.builds\mvc_calculator\MVC_Calculator-{BUILDNUMBER}\buildfiles\RELEASE_NOTES-{version}.txt
```

Or place it at:
```
C:\Users\Scott\Documents\.builds\mvc_calculator\RELEASE_NOTES-{version}.txt
```

**Format:**
```
Date: DD MMM YYYY
Description: Brief description of this release

What's New:
- Feature 1
- Feature 2

Bug Fixes:
- Fix 1
- Fix 2
```

### Step 6: Deploy to Server

**Location:** Project root directory (run from Windows or WSL)

```bash
# Generate index.html locally (no upload)
python deploy_release_ftp.py

# Generate and upload to FTP server
python deploy_release_ftp.py -u
```

**What this does:**
1. Scans for build files in versioned directories
2. Finds latest and previous release files (MSI, ZIP, DEB, AppImage)
3. Reads release notes from `buildfiles/RELEASE_NOTES-{version}.txt`
4. Generates `index.html` with release information
5. Uploads to FTP server: `ftp.moviolabs.com:/public_html/downloads/MVC_Calculator/releases`
6. Uploads logo, build files, release notes, and index.html

**Smart upload:** Skips files that already exist with the same size (prevents duplicates)

## Quick Reference

### Windows Build Only
```bash
python BUILD_ALL_WINDOWS.py
python deploy_release_ftp.py -u
```

### Full Build (Windows + Linux)
```bash
# On Windows
python BUILD_ALL_WINDOWS.py

# In WSL
python BUILD_ALL_LINUX.py

# Back on Windows (or WSL)
python deploy_release_ftp.py -u
```

## File Structure After Build

```
C:\Users\Scott\Documents\.builds\mvc_calculator\
├── MVC_Calculator-25.11-alpha.01.80\          (Latest version)
│   ├── MVC_Calculator-25.11-alpha.01.80.msi
│   ├── MVC_Calculator-25.11-alpha.01.80-portable.zip
│   ├── mvc-calculator_25.11-alpha.01.80_amd64.deb
│   ├── MVC_Calculator-25.11-alpha.01.80-x86_64.AppImage
│   └── buildfiles\
│       ├── RELEASE_NOTES-25.11-alpha.01.80.txt
│       └── (build logs and artifacts)
├── MVC_Calculator-25.11-alpha.01.79\          (Previous version)
│   └── (same structure)
└── index.html                                 (generated by deploy script)
```

## Important Notes

1. **Version Consistency:** The Linux build reads the build number that was incremented by the Windows build, ensuring both platforms use the same version number.

2. **Build Order:** Always run Windows build first (it increments the version), then Linux build.

3. **Release Notes:** The deploy script looks for release notes in the `buildfiles` subdirectory first, then falls back to the base directory.

4. **HTML Generation:** The deploy script only includes the latest (n) and previous (n-1) releases in the generated HTML page.

5. **Upload Options:**
   - `python deploy_release_ftp.py` - Generate HTML only (no upload)
   - `python deploy_release_ftp.py -u` - Generate and upload everything
   - `python deploy_release_ftp.py -u --upload-auxiliary` - Upload auxiliary files (track_download.php, etc.) even when no builds are found

## Troubleshooting

### Build Fails
- Check that all dependencies are installed
- Verify WiX Toolset is installed (for MSI builds)
- Check build logs in `buildfiles/` directory

### Version Mismatch
- Ensure Windows build runs first (it increments the version)
- Linux build reads the version from `utilities/version_info.py`

### FTP Upload Fails
- Check FTP credentials in `deploy_release_ftp.py`
- Verify network connection
- Check that build files exist in expected locations

